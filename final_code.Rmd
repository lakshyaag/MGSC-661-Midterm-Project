---
title: "MGSC 661 - Midterm Project"
output:
  pdf_document: default
  html_notebook: default
---

# Importing libraries and data

```{r include=FALSE}
Sys.setlocale("LC_ALL", "C")
require(visreg)
require(glue)
require(car)
require(lmtest)
require(splines)
require(psych)
require(stargazer)
require(plm)
require(ggplot2)
require(ggtext)
require(ggpubr)
require(ggrepel)
require(ggthemes)
require(scales)
require(caTools)
require(methods)
require(boot)
require(tidyverse)
require(dplyr)
require(glue)

windowsFonts(Helvetica = "Product Sans")
set.seed(420)
```

```{r}
theme_lox <- function() {
  theme(
    panel.grid.major.x = element_line(linewidth = 0.3, colour = "#cbcbcb"),
    panel.grid.major.y = element_line(linewidth = 0.3, colour = "#cbcbcb"),
    plot.title = element_markdown(
      family = "Helvetica",
      size = 22,
      face = "bold",
      color = "#222222"
    ),
    plot.subtitle = element_text(
      family = "Helvetica",
      size = 16,
      margin = margin(2, 0, 2, 0)
    ),
    plot.caption = element_text(family = "Helvetica", face = "bold"),
    axis.text = element_text(
      family = "Helvetica",
      size = 12,
      color = "#222222"
    ),
    axis.title = element_text(
      family = "Helvetica",
      size = 14,
      color = "#222222"
    ),
    legend.text = element_text(family = "Helvetica", size = 12),
    legend.title = element_text(
      family = "Helvetica",
      size = 14,
      face = "bold"
    ),
    legend.position = "right",
    strip.text = element_text(
      family = "Helvetica",
      size = 12,
      hjust = 0.5
    )
  )
}
```

```{r}
data <- read.csv("./IMDB_data_Fall_2023.csv")
```

# Exploratory data analysis

```{r}
head(data)
summary(data)
```

### $y = \text{IMDB Score}$

```{r}
ggplot(data, aes(x = imdb_score)) +
  geom_histogram(binwidth = 1) +
  scale_x_continuous(breaks = breaks_width(width = 1)) +
  labs(x = "IMDb Rating", y = "Number of movies", title = "Distribution of ratings") +
  theme_pubr() +
  theme_lox()
```

### Movie budget

```{r}
ggplot(data, aes(x = movie_budget)) +
  geom_histogram(bins = 20) +
  scale_x_continuous(breaks = breaks_pretty(), labels = label_dollar(scale_cut = cut_short_scale())) +
  labs(x = "Movie budget", y = "Number of movies", title = "Distribution of movie budgets") +
  theme_pubr() +
  theme_lox()
```

### Release year

```{r}
ggplot(data, aes(x = release_year)) +
  geom_histogram(bins = 10) +
  scale_x_continuous(breaks = breaks_pretty(n = 10)) +
  labs(x = "Release Year", y = "Number of movies", title = "Distribution of release year") +
  theme_pubr() +
  theme_lox()
```

### Number of faces

```{r}
ggplot(data, aes(x = nb_faces)) +
  geom_histogram() +
  scale_x_continuous(breaks = breaks_pretty()) +
  labs(x = "Number of faces", y = "Number of movies", title = "Distribution of number of faces in the movie poster") +
  theme_pubr() +
  theme_lox()
```

### Duration

```{r}
ggplot(data, aes(x = duration)) +
  geom_boxplot() +
  scale_x_continuous(breaks = breaks_pretty()) +
  labs(x = "Duration", title = "Boxplot of movie duration") +
  theme_pubr() +
  theme_lox() +
  theme(axis.ticks.y = element_blank(), axis.text.y = element_blank())
```

## Bivariate distributions

### $\text{Movie budgets} \sim y$

```{r}
ggplot(data, aes(x = movie_budget, y = imdb_score)) +
  geom_point() +
  geom_text_repel(aes(label = movie_title), size = 3, max.overlaps = 5, nudge_y = 0.5) +
  scale_x_continuous(breaks = breaks_pretty(), labels = label_dollar(scale_cut = cut_short_scale())) +
  labs(x = "Movie budget", y = "IMDb Score", title = "Movie budget and IMDb score") +
  theme_pubr() +
  theme_lox()
```

### $\text{Duration} \sim y$

```{r}
ggplot(data, aes(x = duration, y = imdb_score)) +
  geom_point() +
  geom_text_repel(aes(label = movie_title), size = 3, max.overlaps = 10, nudge_y = 0.5) +
  scale_x_continuous(breaks = breaks_pretty(), labels = label_number()) +
  labs(x = "Duration", y = "IMDb Score", title = "Movie duration and IMDb score") +
  theme_pubr() +
  theme_lox()
```

### $\text{Genre} \sim y$

```{r}
data %>%
  select(movie_id, imdb_score, action:crime) %>%
  pivot_longer(cols = c(-imdb_score, -movie_id), names_to = "genre") %>%
  mutate(genre = str_to_sentence(genre)) %>%
  group_by(genre) %>%
  filter(value == 1) %>%
  summarise(avg_score = mean(imdb_score), num_movies = n()) %>%
  ggplot(aes(x = genre, y = avg_score, fill = genre)) +
  geom_col() +
  geom_text_repel(aes(y = avg_score, label = num_movies), nudge_y = 0.1) +
  scale_fill_tableau(palette = "Tableau 20") +
  scale_y_continuous(breaks = breaks_pretty(), limits = c(0, 10)) +
  guides(fill = "none") +
  labs(x = "Genre", y = "Average IMDb Score", title = "Average IMDb score by genre") +
  theme_pubr() +
  theme_lox() +
  theme(panel.grid.major.x = element_blank())
```

```{r fig.width = 10}
data %>%
  select(movie_id, movie_title, imdb_score, action:crime) %>%
  pivot_longer(cols = c(-imdb_score, -movie_id, -movie_title), names_to = "genre") %>%
  mutate(genre = str_to_sentence(genre)) %>%
  group_by(genre) %>%
  filter(value == 1) %>%
  ggplot(aes(x = genre, y = imdb_score, fill = genre)) +
  geom_boxplot() +
  scale_fill_tableau(palette = "Tableau 20") +
  scale_y_continuous(breaks = breaks_pretty(), limits = c(0, 10)) +
  guides(fill = "none") +
  labs(x = "Genre", y = "IMDb Score", title = "Boxplot of IMDb score by genre", caption = "Movies span across genres") +
  theme_pubr() +
  theme_lox()
```

### $\text{Release Month} \sim y$

```{r}
data %>%
  mutate(release_date = dmy(str_c(release_day, release_month, release_year, sep = "-"))) %>%
  mutate(release_month = month(release_date, label = TRUE)) %>%
  ggplot(aes(x = release_month, y = imdb_score, fill = release_month)) +
  geom_boxplot(outlier.size = 3) +
  geom_text_repel(aes(label = movie_title), max.overlaps = 5) +
  scale_fill_tableau(palette = "Tableau 20") +
  scale_y_continuous(breaks = breaks_pretty(), limits = c(0, 10)) +
  guides(fill = "none") +
  labs(x = "Release Month", y = "IMDb Score", title = "Boxplot of IMDb score by release month") +
  theme_pubr() +
  theme_lox()
```

### $\text{Actor 1} \sim y$

```{r fig.width = 12, fig.height = 8}
data %>%
  filter(actor1 %in% (
    data %>%
      group_by(actor1) %>%
      count(sort = TRUE) %>%
      head(10)
  )$actor1) %>%
  ggplot(aes(
    x = fct_reorder(actor1, imdb_score, .fun = median),
    y = imdb_score,
    fill = actor1
  )) +
  geom_boxplot(outlier.size = 3) +
  geom_text_repel(aes(label = movie_title), max.overlaps = 7) +
  scale_fill_tableau(palette = "Tableau 20") +
  scale_y_continuous(breaks = breaks_pretty(), limits = c(0, 10)) +
  guides(fill = "none") +
  labs(
    x = "Actor 1 Name",
    y = "IMDb Score",
    title = "Boxplot of IMDb score by Actor 1",
    subtitle = "Top 10 actors by number of movies shown"
  ) +
  theme_pubr() +
  theme_lox() +
  coord_flip()

```

### $\text{Distributor} \sim y$

```{r fig.width = 12, fig.height=8}
data %>%
  filter(distributor %in%
           (data %>%
              group_by(distributor) %>%
              count(sort = TRUE) %>%
              head(10))$distributor) %>%
  ggplot(aes(x = distributor, y = imdb_score, fill = distributor)) +
  geom_boxplot(outlier.size = 3) +
  geom_text_repel(aes(label = movie_title), max.overlaps = 5) +
  scale_fill_tableau(palette = "Tableau 20") +
  scale_y_continuous(breaks = breaks_pretty(), limits = c(0, 10)) +
  guides(fill = "none") +
  labs(
    x = "Distributor",
    y = "IMDb Score",
    title = "Boxplot of IMDb score by distributor",
    subtitle = "Top 10 distributors by number of movies shown"
  ) +
  theme_pubr() +
  theme_lox() +
  coord_flip()
  
```

# Data preprocessing

## Checking data types

```{r}
data %>% str()
```

```{r}
data_cleaned <- data %>%
  mutate(across(
    .cols = c(
      'language',
      'country',
      'maturity_rating',
      'aspect_ratio',
      'distributor',
      'director',
      'colour_film',
      'cinematographer',
      'production_company'
    ),
    ~ factor(.x)
  ))

data_cleaned <- data_cleaned %>%
  mutate(release_month = month(fast_strptime(release_month, format = "%b"), label =
                                 TRUE)) %>%
  mutate(release_month = factor(release_month, levels = month.abb, ordered = FALSE))
```


## Standardizing numerical columns
```{r}
data_cleaned <- data_cleaned %>%
  mutate(across(
    .cols = c(
      "movie_budget",
      'duration',
      'nb_news_articles',
      'actor1_star_meter',
      'actor2_star_meter',
      'actor3_star_meter',
      'nb_faces',
      'movie_meter_IMDBpro'
    ),
    .fns = ~scale(.) %>% as.vector()
  ))
```


## Checking for multicollinearity

```{r}
vif_model <- lm(imdb_score ~ ., data = (data_cleaned %>% select(where(is.numeric))))

vif(vif_model)
```

We see that there is no multicollinearity among the numeric variables in the dataset.

## Feature engineering

### Checking levels for categorical columns

```{r}
categorical_columns <- data_cleaned %>%
  summarize(across(where(is.factor), ~nlevels(.x))) %>%
  pivot_longer(everything(), names_to = "variable", values_to = "num_levels")

categorical_columns
```

We see that director, cinematographer, and production company have a lot of unique values. A priori, we expect to drop these columns when building the model.

Let us check the counts for the other variables

```{r}
categorical_columns %>% 
  filter(!variable %in% c("director", "cinematographer", "production_company")) %>%
  pull(variable) %>%
  walk(
    ~ data_cleaned %>%
      group_by_at(.x) %>%
      count(sort = TRUE) %>%
      print()
  )
    
```

We see that:

-   The language is primarily "English"
-   The country is primarily "USA"
-   The films are primarily "Color"

These features can also be dropped when building the model.

Further:
-   The aspect ratios are primarily "2.35" or "1.85"
-   The maturity ratings are primarily "R", "PG-13" or "PG"

For these features, rows containing values apart from the ones specified above can be lumped into an "Other" category.

For distributor and plot keywords, we can create binary features for the top 10 values by count.

### Lumping factors into "Others"
```{r}
data_cleaned <- data_cleaned %>% mutate(
  aspect_ratio = fct_lump_n(aspect_ratio, n = 3),
  maturity_rating = fct_lump_n(maturity_rating, n = 4)
)
```


### Top 10 keywords

```{r}
top_10_keywords <- data_cleaned %>%
  select(plot_keywords) %>%
  separate_longer_delim(cols = "plot_keywords", delim = "|") %>%
  group_by(plot_keywords) %>%
  count(sort = TRUE) %>%
  head(10)

for (keyword in top_10_keywords$plot_keywords) {
  col_name <- glue("plot_{keyword}")
  data_cleaned[[col_name]] <-
    as.integer(lapply(data_cleaned$plot_keywords, function (x) {
      str_detect(x, keyword)
    }))
}
```

### Top 5 distributors

```{r}
top_5_distributors <- data_cleaned %>%
  select(distributor) %>%
  separate_longer_delim(cols = "distributor", delim = "|") %>%
  group_by(distributor) %>%
  count(sort = TRUE) %>%
  head(5)

for (distributor in top_5_distributors$distributor) {
  col_name <- glue("distributor_{distributor}")
  data_cleaned[[col_name]] <-
    as.integer(lapply(data_cleaned$distributor, function (x) {
      str_detect(x, distributor)
    }))
}
```

## Removing variables

```{r}
columns_to_remove <-
  c(
    "movie_id",
    "movie_title",
    "imdb_link",
    "actor1",
    "actor2",
    "actor3",
    "genres",
    "release_year",
    "colour_film",
    "director", 
    "cinematographer", 
    "production_company",
    "language",
    "country",
    "distributor",
    "plot_keywords"
  )

data_cleaned <- data_cleaned %>% select(-all_of(columns_to_remove))
```

```{r}
data_cleaned %>% head()
```

# Model building

## Basic linear regression - using all features
```{r}
lin_reg_1 <- lm(imdb_score ~ ., data=data_cleaned)
summary(lin_reg_1)
residualPlot(lin_reg_1)
```
### Checking for outliers
```{r}
outlierTest(lin_reg_1)
```
```{r}
outliers <- names(outlierTest(lin_reg_1)[[1]])
data_cleaned <- data_cleaned %>% filter(!row_number() %in% outliers)
```

### Running the model with outliers removed
```{r}
lin_reg_2 <- lm(imdb_score ~ ., data=data_cleaned)
summary(lin_reg_2)
residualPlot(lin_reg_2)
```

After removing the outliers, we see that the non-linearity has reduced. Let us now check for heteroskedasticity.

### Heteroskedasticity
```{r}
ncvTest(lin_reg_2)
```

Since the model contains heteroskedasticity, we can check the corrected coefficients.
```{r}
coeftest(lin_reg_2, vcov = vcovHC(lin_reg_2, type = "HC1"))
```

### Performance
```{r}
predicted_scores <- predict(lin_reg_2, data_cleaned)
actual_scores <- data_cleaned$imdb_score
mse <- mean((actual_scores - predicted_scores)^2)
mse
```

## Linear regression - K-fold
```{r}
sample <- sample.split(data_cleaned$imdb_score, SplitRatio = 0.7)
train <- subset(data_cleaned, sample == TRUE)
test <- subset(data_cleaned, sample == FALSE)

lin_reg_k <- glm(imdb_score ~ ., data = train)
mse_train_lin_reg_k <- cv.glm(train, lin_reg_k, K = 5)$delta[1]

mse_test_lin_reg_k <- mean((predict(lin_reg_k, test) - test$imdb_score)^2)

print(glue("Training set MSE: {mse_train_lin_reg_k}"))
print(glue("Test set MSE: {mse_test_lin_reg_k}"))

summary(lin_reg_k)
```


## Polynomial regression

Before running a polynomial regression, let us check the linearity of predictors in the linear regression model
```{r}
residualPlots(lin_reg_k, terms= ~ movie_budget + duration + nb_news_articles + movie_meter_IMDBpro)
```

```{r}
poly_k_fold_mse <- function(d1, d2, d3, d4, k) {
  poly_k_fold <- glm(imdb_score ~ poly(movie_budget, d1) + poly(duration, d2) + poly(nb_news_articles, d3) + poly(movie_meter_IMDBpro, d4) + . - movie_budget - duration - nb_news_articles - movie_meter_IMDBpro, data = data_cleaned)
  
  mse_k_fold <- cv.glm(data_cleaned, poly_k_fold, K = k)$delta[1]
  print(glue("MSE for degrees ({d1}, {d2}, {d3}, {d4}) on {k}-fold CV: {mse_k_fold}"))
  mse_k_fold
}
```


### Finding the optimal degree for numeric features using K-fold CV
```{r}
mse_poly_k_fold_df = data.frame(
  i = rep(NA, 4 ^ 4),
  j = rep(NA, 4 ^ 4),
  k = rep(NA, 4 ^ 4),
  l = rep(NA, 4 ^ 4),
  mse = rep(NA, 4 ^ 4)
)
for (i in 2:5) {
  for (j in 2:5) {
    for (k in 2:5) {
      for (l in 2:5) {
        mse_poly_k_fold_df[nrow(mse_poly_k_fold_df) + 1, ] <-
          c(i, j, k, l, poly_k_fold_mse(i, j, k, l, 5))
      }
    }
  }
}
```

```{r}
mse_poly_k_fold_df[which.min(mse_poly_k_fold_df$mse), ]
```

## Spline regression

First spline model
```{r}
spline_model_1 <- glm(imdb_score ~
                               poly(movie_budget,2) +
                               bs(duration, knots = quantile(duration, c(0.25, 0.5, 0.75)), degree = 4) +
                               bs(nb_news_articles, knots = quantile(nb_news_articles, c(0.25, 0.5, 0.75)), degree = 1) +
                               bs(movie_meter_IMDBpro, knots = quantile(movie_meter_IMDBpro, c(0.25, 0.5, 0.75)), degree = 1),
                               data = data)
summary(spline_model_1)
set.seed(123)
cv_results <- cv.glm(data, spline_model_1, K = 20)
mse <- cv_results$delta[1]
print(mse)

r_squared <- 1 - (spline_model_1$deviance / spline_model_1$null.deviance)
print(r_squared)

```
Changes made to the data:
```{r}
outlierTest(spline_model_1)
# added 6 after another test mid-buidling
outliers <- c(113, 213, 893, 714, 432, 494, 786, 515, 923, 6)
data_cleaned <- data[-outliers, ]

dummy_matrix <- model.matrix(~ release_month - 1, data=data_cleaned)

# Convert the matrix to a data frame and add to the original data
data_cleaned <- cbind(data_cleaned, as.data.frame(dummy_matrix))
```


# Advanced spline model with some categorical variables
Using loops to find combination of predictors with lowest mse
Note: release_month can be removed, the MSE loss in small (~0.02)
MSE = 0.5399608
Rsquare = 0.4860416
```{r}
spline_model_4 <- glm(imdb_score ~
                               poly(movie_budget,2) + 
                     bs(duration, knots = quantile(duration, c(0.25, 0.5, 0.75)), degree = 4) + 
                     bs(nb_news_articles, knots = quantile(nb_news_articles, c(0.25, 0.5, 0.75)), degree = 1) + 
                     bs(movie_meter_IMDBpro, knots = quantile(movie_meter_IMDBpro, c(0.25, 0.5, 0.75)), degree = 1) + 
                     duration:movie_meter_IMDBpro + action + adventure + thriller + 
                     romance + horror + drama + war + animation + release_monthFeb + release_monthApr + release_monthMay + release_monthJul + release_monthAug + release_monthSep ,
                               data = data_cleaned)
summary(spline_model_4)
set.seed(123)
cv_results <- cv.glm(data_cleaned, spline_model_4, K = 20)
mse <- cv_results$delta[1]
print("mse =")
print(mse)

r_squared <- 1 - (spline_model_4$deviance / spline_model_4$null.deviance)
print(r_squared)
```

